version: "3.8"

services:
  # Discovery Service - Must start first
  discovery-service:
    build:
      context: .
      dockerfile: discovery-service/Dockerfile
    container_name: discovery-service
    image: ghcr.io/ntabodoiqua/cnweb-discovery-service:${TAG:-latest}
    ports:
      - "8761:8761"
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8761/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # API Gateway - Depends on Discovery Service
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    image: ghcr.io/ntabodoiqua/cnweb-api-gateway:${TAG:-latest}
    ports:
      - "8080:8080"
    networks:
      - microservices-network
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Ho_Chi_Minh
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    depends_on:
      discovery-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8080/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # User Service - Depends on Discovery Service
  user-service:
    build:
      context: .
      dockerfile: user-service/Dockerfile
    container_name: user-service
    image: ghcr.io/ntabodoiqua/cnweb-user-service:${TAG:-latest}
    ports:
      - "8081:8081"
    networks:
      - microservices-network
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Ho_Chi_Minh
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db-postgresql-sgp1-29269-do-user-23301452-0.k.db.ondigitalocean.com:25060/user_service?sslmode=require
      - SPRING_DATASOURCE_USERNAME=doadmin
      - SPRING_DATASOURCE_PASSWORD=AVNS_yX_L2SKXt73ktjTiGbU
      - SPRING_DATA_REDIS_HOST=db-valkey-sgp1-50141-do-user-27848320-0.k.db.ondigitalocean.com
      - SPRING_DATA_REDIS_PORT=25061
      - SPRING_DATA_REDIS_USERNAME=default
      - SPRING_DATA_REDIS_PASSWORD=AVNS_N-gwsyNb6xBC3fXPdQp
      - SPRING_DATA_REDIS_SSL_ENABLED=true
      - SPRING_RABBITMQ_ADDRESSES=amqps://xqjmojji:hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH@fuji.lmq.cloudamqp.com/xqjmojji
      - SPRING_RABBITMQ_USERNAME=xqjmojji
      - SPRING_RABBITMQ_PASSWORD=hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH
      - SPRING_RABBITMQ_VIRTUAL_HOST=xqjmojji
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - JWT_SIGNERKEY=cnf61zcey4yE0RfDwk3yOAgi+CRVsjb1LPQP0O9e0GyLworFq8IthDFERD/0bxy2
    volumes:
      - user-uploads:/app/uploads
    depends_on:
      discovery-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8081/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Product Service - Depends on Discovery Service
  product-service:
    build:
      context: .
      dockerfile: product-service/Dockerfile
    container_name: product-service
    image: ghcr.io/ntabodoiqua/cnweb-product-service:${TAG:-latest}
    ports:
      - "8082:8082"
    networks:
      - microservices-network
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db-postgresql-sgp1-29269-do-user-23301452-0.k.db.ondigitalocean.com:25060/product_service?sslmode=require
      - SPRING_DATASOURCE_USERNAME=doadmin
      - SPRING_DATASOURCE_PASSWORD=AVNS_yX_L2SKXt73ktjTiGbU
      - SPRING_DATA_REDIS_HOST=db-valkey-sgp1-50141-do-user-27848320-0.k.db.ondigitalocean.com
      - SPRING_DATA_REDIS_PORT=25061
      - SPRING_DATA_REDIS_USERNAME=default
      - SPRING_DATA_REDIS_PASSWORD=AVNS_N-gwsyNb6xBC3fXPdQp
      - SPRING_DATA_REDIS_SSL_ENABLED=true
      - SPRING_RABBITMQ_ADDRESSES=amqps://xqjmojji:hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH@fuji.lmq.cloudamqp.com/xqjmojji
      - SPRING_RABBITMQ_USERNAME=xqjmojji
      - SPRING_RABBITMQ_PASSWORD=hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH
      - SPRING_RABBITMQ_VIRTUAL_HOST=xqjmojji
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - JWT_SIGNERKEY=cnf61zcey4yE0RfDwk3yOAgi+CRVsjb1LPQP0O9e0GyLworFq8IthDFERD/0bxy2
    volumes:
      - product-uploads:/app/uploads
    depends_on:
      discovery-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8082/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Notification Service - Depends on Discovery Service
  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    image: ghcr.io/ntabodoiqua/cnweb-notification-service:${TAG:-latest}
    ports:
      - "8084:8084"
    networks:
      - microservices-network
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Ho_Chi_Minh
      - SPRING_RABBITMQ_ADDRESSES=amqps://xqjmojji:hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH@fuji.lmq.cloudamqp.com/xqjmojji
      - SPRING_RABBITMQ_USERNAME=xqjmojji
      - SPRING_RABBITMQ_PASSWORD=hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH
      - SPRING_RABBITMQ_VIRTUAL_HOST=xqjmojji
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-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}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    depends_on:
      discovery-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8084/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # File Service - Depends on Discovery Service
  file-service:
    build:
      context: .
      dockerfile: file-service/Dockerfile
    container_name: file-service
    image: ghcr.io/ntabodoiqua/cnweb-file-service:${TAG:-latest}
    ports:
      - "8083:8083"
    networks:
      - microservices-network
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Ho_Chi_Minh
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db-postgresql-sgp1-93557-do-user-27848320-0.d.db.ondigitalocean.com:25060/file_service?sslmode=require
      - SPRING_DATASOURCE_USERNAME=doadmin
      - SPRING_DATASOURCE_PASSWORD=AVNS_GP853Gug731-gzXfmnT
      - SPRING_DATA_REDIS_HOST=db-valkey-sgp1-50141-do-user-27848320-0.k.db.ondigitalocean.com
      - SPRING_DATA_REDIS_PORT=25061
      - SPRING_DATA_REDIS_USERNAME=default
      - SPRING_DATA_REDIS_PASSWORD=AVNS_N-gwsyNb6xBC3fXPdQp
      - SPRING_DATA_REDIS_SSL_ENABLED=true
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - JWT_SIGNERKEY=cnf61zcey4yE0RfDwk3yOAgi+CRVsjb1LPQP0O9e0GyLworFq8IthDFERD/0bxy2
      - S3_ENDPOINT=https://sgp1.digitaloceanspaces.com
      - S3_REGION=sgp1
      - S3_BUCKET_NAME=hla
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-DO007GZR7WN63YHWKLVU}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-LPB+xqPNyJ8RTN7Syg3932nDFqZOsGb2X3wa6jWV+yA}
    depends_on:
      discovery-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8083/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Order Service - Depends on Discovery Service
  order-service:
    build:
      context: .
      dockerfile: order-service/Dockerfile
    container_name: order-service
    image: ghcr.io/ntabodoiqua/cnweb-order-service:${TAG:-latest}
    ports:
      - "8085:8085"
    networks:
      - microservices-network
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Ho_Chi_Minh
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db-postgresql-sgp1-29269-do-user-23301452-0.k.db.ondigitalocean.com:25061/order_service?sslmode=require
      - SPRING_DATASOURCE_USERNAME=doadmin
      - SPRING_DATASOURCE_PASSWORD=AVNS_yX_L2SKXt73ktjTiGbU
      - SPRING_DATA_REDIS_HOST=db-valkey-sgp1-50141-do-user-27848320-0.k.db.ondigitalocean.com
      - SPRING_DATA_REDIS_PORT=25061
      - SPRING_DATA_REDIS_USERNAME=default
      - SPRING_DATA_REDIS_PASSWORD=AVNS_N-gwsyNb6xBC3fXPdQp
      - SPRING_DATA_REDIS_SSL_ENABLED=true
      - SPRING_RABBITMQ_ADDRESSES=amqps://xqjmojji:hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH@fuji.lmq.cloudamqp.com/xqjmojji
      - SPRING_RABBITMQ_USERNAME=xqjmojji
      - SPRING_RABBITMQ_PASSWORD=hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH
      - SPRING_RABBITMQ_VIRTUAL_HOST=xqjmojji
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - JWT_SIGNERKEY=cnf61zcey4yE0RfDwk3yOAgi+CRVsjb1LPQP0O9e0GyLworFq8IthDFERD/0bxy2
      - INTERNAL_SERVICE_SECRET=${INTERNAL_SERVICE_SECRET:-InT3rn@l-S3rv1c3-S3cr3t-K3y-2025-VDT}
      - PAYMENT_REDIRECT_URL=${PAYMENT_REDIRECT_URL:-https://nguyentheanh-nta.id.vn/payment/result}
    depends_on:
      discovery-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8085/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Payment Service - Depends on Discovery Service
  payment-service:
    build:
      context: .
      dockerfile: payment-service/Dockerfile
    container_name: payment-service
    image: ghcr.io/ntabodoiqua/cnweb-payment-service:${TAG:-latest}
    ports:
      - "8086:8086"
    networks:
      - microservices-network
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Ho_Chi_Minh
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db-postgresql-sgp1-29269-do-user-23301452-0.k.db.ondigitalocean.com:25060/payment_service?sslmode=require
      - SPRING_DATASOURCE_USERNAME=doadmin
      - SPRING_DATASOURCE_PASSWORD=AVNS_yX_L2SKXt73ktjTiGbU
      - SPRING_DATA_REDIS_HOST=db-valkey-sgp1-50141-do-user-27848320-0.k.db.ondigitalocean.com
      - SPRING_DATA_REDIS_PORT=25061
      - SPRING_DATA_REDIS_USERNAME=default
      - SPRING_DATA_REDIS_PASSWORD=AVNS_N-gwsyNb6xBC3fXPdQp
      - SPRING_DATA_REDIS_SSL_ENABLED=true
      - SPRING_RABBITMQ_ADDRESSES=amqps://xqjmojji:hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH@fuji.lmq.cloudamqp.com/xqjmojji
      - SPRING_RABBITMQ_USERNAME=xqjmojji
      - SPRING_RABBITMQ_PASSWORD=hn8Iv-4Aa0YFZRmZuLtz6jMB0xoZl8TH
      - SPRING_RABBITMQ_VIRTUAL_HOST=xqjmojji
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - JWT_SIGNERKEY=cnf61zcey4yE0RfDwk3yOAgi+CRVsjb1LPQP0O9e0GyLworFq8IthDFERD/0bxy2
      - ZALOPAY_APP_ID=${ZALOPAY_APP_ID:-2554}
      - ZALOPAY_KEY1=${ZALOPAY_KEY1:-sdngKKJmqEMzvh5QQcdD2A9XBSKUNaYn}
      - ZALOPAY_KEY2=${ZALOPAY_KEY2:-trMrHtvjo6myautxDUiAcYsVtaeQ8nhf}
      - ZALOPAY_CREATE_ORDER_URL=${ZALOPAY_CREATE_ORDER_URL:-https://sb-openapi.zalopay.vn/v2/create}
      - ZALOPAY_QUERY_ORDER_URL=${ZALOPAY_QUERY_ORDER_URL:-https://sb-openapi.zalopay.vn/v2/query}
      - ZALOPAY_GET_BANK_LIST_URL=${ZALOPAY_GET_BANK_LIST_URL:-https://sbgateway.zalopay.vn/api/getlistmerchantbanks}
      - ZALOPAY_CALLBACK_URL=${ZALOPAY_CALLBACK_URL:-http://146.190.101.2:8080/api/payment/v1/payments/zalopay/callback}
      - ZALOPAY_REDIRECT_URL=${ZALOPAY_REDIRECT_URL:-http://localhost:3000/payment/result}
    depends_on:
      discovery-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8086/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  microservices-network:
    name: app-network
    driver: bridge

volumes:
  user-uploads:
    driver: local
  product-uploads:
    driver: local
